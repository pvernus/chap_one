---
title: "Untitled"
format: docx
editor: visual
bibliography: references.bib
---

```{r, load_pckg}

source(here::here('scripts', 'library.R'))
```

```{r load_data}

# outcome
load(file =  "C:\\Users\\pauvernu\\Seafile\\library\\chap_one_data\\data\\outcome\\data_outcome.RData")
# treatment
load(file = "C:\\Users\\pauvernu\\Seafile\\library\\chap_one_data\\data\\treatment\\data_treatment.RData")
# covariates
# load(here('data', 'data_covariate.RData'))
```

> NOTE(1): should the typology (categories) be defined here or earlier in data_crs? E.g. data cleaning in `data_crs` and data transformation in `data_sample`
>
> NOTE(2): same question as above for the definition of the observation window.

# Sample

```{r sample_data}

outcome <- data_outcome |> 
  select(donor_id, recipient_id, year, starts_with("commit"))

treatment <- data_treatment |> 
  select(iso3c, year, starts_with(c("dis", "cohort", "rel")), treat_first:treat_large_first_stag)

data_sample <- left_join(data_unit, outcome, by = c("donor_id", "recipient_id", "year")) |> 
  left_join(treatment, by = c("iso3c", "year")) |> 
  mutate(id = paste(donor_id, recipient_id, sep = "_")) |> 
  relocate(id, .before = year)

est = data_sample |> 
  select(year, id, donor_id, recipient_id, 
         y.name = commit_total, 
         g.name = cohort_dis_large, 
         dis_large_dummy, 
         time_to_treatment = rel_time_large) |> 
  filter(year >= 2004) |> 
  mutate(t = year - min(year) + 1) |> 
  mutate(time_to_treatment = ifelse(time_to_treatment %in% -10:10, time_to_treatment, -1000)) |> 
  mutate(y.name = ifelse(y.name < 0, 0, y.name)) |> 
#  filter(time_to_treatment != -1000)
  fepois(y.name ~ i(time_to_treatment, c(-1, -1000)) | id + year + donor_id^year + recipient_id[t])
#  fepois(y.name ~ sunab(g.name, year) | id + year + donor_id^year + recipient_id[t])

# install.packages("ggfixest")
ggfixest::ggiplot(est) ## this package

# varying slopes: fe1[x2]

  mutate(across(matches("^D_(L|H)"), \(x) replace_na(x, 0))) |> 
  mutate(across(matches("^cohort"), \(x) replace_na(x, 9999))) |> 
  left_join(data_covariate, by = c("iso3c", "year"))

```

```{r save}

save(data_sample,
     file = here("data", "data_sample.RData"))
```
